{"componentChunkName":"component---src-templates-blog-post-js","path":"/nginx-nodejs/","result":{"data":{"site":{"siteMetadata":{"title":"Trainto.log()"}},"markdownRemark":{"id":"a944aae6-496a-5e39-a352-c23cbd7f5563","excerpt":"Recently I deployed a Node.js(Express) web application on AWS, and I used Nginx as its reverse proxy. So I want to take notes. Why do we need reverse proxy? SSL…","html":"<p>Recently I deployed a Node.js(Express) web application on AWS, and I used Nginx as its reverse proxy. So I want to take notes.</p>\n<h2>Why do we need reverse proxy?</h2>\n<h3>SSL</h3>\n<p>SSL might be the most popular reason, but in my case, I’m using AWS’s load balancer and SSL is being handled by it. So SSL is not the reason I use reverse proxy.</p>\n<h3>gzip</h3>\n<p>gzip compression is also popular feature which you should offload from the application to a reverse proxy. You should make your application server only focus on application logic for performance reasons.</p>\n<h3>static asset</h3>\n<p>The best way is to use nginx server to serve you static file and let you node.js server handle the dynamic content. That would be the most optimized solution to reduce the amount of requests on your node.js server that is slower to server static files than nginx. and the configuration to achieve that is very simple.</p>\n<h2>nginx.conf</h2>\n<p>Once you install Nginx, you can find it under /etc/nginx, and there will be ‘nginx.conf’ file which is the default configuration file.</p>\n<p>For the nginx.conf configurationf file, I changed just two things. First, turning off server tokens which might be security issue, and turning on gzip compression.</p>\n<div class=\"gatsby-highlight\" data-language=\"nginx\"><pre class=\"language-nginx\"><code class=\"language-nginx\"><span class=\"token directive\"><span class=\"token keyword\">http</span></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">##</span>\n    <span class=\"token comment\"># Basic Settings</span>\n    <span class=\"token comment\">##</span>\n\n    <span class=\"token directive\"><span class=\"token keyword\">sendfile</span> <span class=\"token boolean\">on</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">tcp_nopush</span> <span class=\"token boolean\">on</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">tcp_nodelay</span> <span class=\"token boolean\">on</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">keepalive_timeout</span> <span class=\"token number\">65</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">types_hash_max_size</span> <span class=\"token number\">2048</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">server_tokens</span> <span class=\"token boolean\">off</span></span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\"># server_names_hash_bucket_size 64;</span>\n    <span class=\"token comment\"># server_name_in_redirect off;</span>\n\n    <span class=\"token directive\"><span class=\"token keyword\">include</span> /etc/nginx/mime.types</span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">default_type</span> application/octet-stream</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">##</span>\n    <span class=\"token comment\"># SSL Settings</span>\n    <span class=\"token comment\">##</span>\n\n    <span class=\"token directive\"><span class=\"token keyword\">ssl_protocols</span> TLSv1 TLSv1.1 TLSv1.2</span><span class=\"token punctuation\">;</span> <span class=\"token comment\"># Dropping SSLv3, ref: POODLE</span>\n    <span class=\"token directive\"><span class=\"token keyword\">ssl_prefer_server_ciphers</span> <span class=\"token boolean\">on</span></span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">##</span>\n    <span class=\"token comment\"># Logging Settings</span>\n    <span class=\"token comment\">##</span>\n\n    <span class=\"token directive\"><span class=\"token keyword\">access_log</span> /var/log/nginx/access.log</span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">error_log</span> /var/log/nginx/error.log</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">##</span>\n    <span class=\"token comment\"># Gzip Settings</span>\n    <span class=\"token comment\">##</span>\n\n    <span class=\"token directive\"><span class=\"token keyword\">gzip</span> <span class=\"token boolean\">on</span></span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token directive\"><span class=\"token keyword\">gzip_vary</span> <span class=\"token boolean\">on</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">gzip_proxied</span> any</span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">gzip_comp_level</span> <span class=\"token number\">6</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">gzip_buffers</span> <span class=\"token number\">16</span> <span class=\"token number\">8k</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">gzip_http_version</span> 1.1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">gzip_types</span> text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">##</span>\n    <span class=\"token comment\"># Virtual Host Configs</span>\n    <span class=\"token comment\">##</span>\n\n    <span class=\"token directive\"><span class=\"token keyword\">include</span> /etc/nginx/conf.d/*.conf</span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">include</span> /etc/nginx/sites-enabled/*</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>To turn off the server tokens(mainly to hide nginx version) and turn off gzip compression, I just uncommented them from default configuration file.</p>\n<h2>Your appplication specific configuration</h2>\n<p>You need to create a configuration file under /etc/nginx/sites-available/ to set your application specific configuration. The file name can be whatever you like.</p>\n<div class=\"gatsby-highlight\" data-language=\"nginx\"><pre class=\"language-nginx\"><code class=\"language-nginx\"><span class=\"token directive\"><span class=\"token keyword\">server</span></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token directive\"><span class=\"token keyword\">listen</span> <span class=\"token number\">80</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">server_name</span> your.domain.com</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token directive\"><span class=\"token keyword\">if</span> (<span class=\"token variable\">$http_x_forwarded_proto</span> = <span class=\"token string\">\"http\"</span>)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token directive\"><span class=\"token keyword\">return</span> <span class=\"token number\">301</span> https://<span class=\"token variable\">$server_name</span><span class=\"token variable\">$request_uri</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token directive\"><span class=\"token keyword\">location</span> /favicon.ico</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token directive\"><span class=\"token keyword\">alias</span> /your/favicon/location/favicon.ico</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token directive\"><span class=\"token keyword\">location</span> /robots.txt</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token directive\"><span class=\"token keyword\">alias</span> /your/robots/locaion/robots.txt</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token directive\"><span class=\"token keyword\">location</span> /static/</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token directive\"><span class=\"token keyword\">alias</span> /your/static/asset/location/</span><span class=\"token punctuation\">;</span>\n        <span class=\"token directive\"><span class=\"token keyword\">expires</span> <span class=\"token number\">30d</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token directive\"><span class=\"token keyword\">location</span> /</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token directive\"><span class=\"token keyword\">proxy_pass</span> http://127.0.0.1:3000</span><span class=\"token punctuation\">;</span>\n        <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span> X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span></span><span class=\"token punctuation\">;</span>\n        <span class=\"token directive\"><span class=\"token keyword\">client_max_body_size</span> <span class=\"token number\">20M</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Specify port and domain first.</p>\n<br />\n<div class=\"gatsby-highlight\" data-language=\"nginx\"><pre class=\"language-nginx\"><code class=\"language-nginx\"><span class=\"token directive\"><span class=\"token keyword\">if</span> (<span class=\"token variable\">$http_x_forwarded_proto</span> = <span class=\"token string\">\"http\"</span>)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token directive\"><span class=\"token keyword\">return</span> <span class=\"token number\">301</span> https://<span class=\"token variable\">$server_name</span><span class=\"token variable\">$request_uri</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>If the request is with http, this configuration redirects it to https permanantly(301).</p>\n<br />\n<div class=\"gatsby-highlight\" data-language=\"nginx\"><pre class=\"language-nginx\"><code class=\"language-nginx\"><span class=\"token directive\"><span class=\"token keyword\">location</span> /favicon.ico</span> <span class=\"token punctuation\">{</span>\n    alias /your/favicon/location\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token directive\"><span class=\"token keyword\">location</span> /robots.txt</span> <span class=\"token punctuation\">{</span>\n    alias /your/robots/location\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token directive\"><span class=\"token keyword\">location</span> /static/</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token directive\"><span class=\"token keyword\">alias</span> /your/static/asset/location\n    expires <span class=\"token number\">30d</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>There are configuratinos for serving static files. If you specify <strong><em>expires</em></strong> like 30d, the static files will have following header <em>cache-control: max-age=2592000</em>, and will be cached in the browser efficiently.</p>\n<br />\n<div class=\"gatsby-highlight\" data-language=\"nginx\"><pre class=\"language-nginx\"><code class=\"language-nginx\"><span class=\"token directive\"><span class=\"token keyword\">location</span> /</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token directive\"><span class=\"token keyword\">proxy_pass</span> http://127.0.0.1:3000</span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span> X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">client_max_body_size</span> <span class=\"token number\">20M</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This configuration will forward requests from clients to your node.js server. <em>prox</em>set<em>header</em> for displaying actual remote ip address when logging, and <em>client</em>max<em>body</em>size_ is literally max body size. In my case, I set it to 20 Megabyte.</p>\n<p>Now you need to make symbolic link to this congifuration file from /etc/nginx/sites-enabled and enter the command following to restart Nginx.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">sudo</span> <span class=\"token function\">service</span> nginx restart</code></pre></div>","frontmatter":{"title":"Nginx - Configure Nginx as reverse proxy for Nodejs(Express)","date":"November 08, 2019","description":null}}},"pageContext":{"slug":"/nginx-nodejs/","previous":{"fields":{"slug":"/docker-mongodb-replicaset/"},"frontmatter":{"title":"Docker - Setting up a MongoDB Replica Set with Docker"}},"next":{"fields":{"slug":"/blog-renewal-with-gatsby/"},"frontmatter":{"title":"Blog renewal with Gatsby"}}}},"staticQueryHashes":["426816048","63159454"]}