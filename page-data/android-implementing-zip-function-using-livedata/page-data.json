{"componentChunkName":"component---src-templates-blog-post-js","path":"/android-implementing-zip-function-using-livedata/","result":{"data":{"site":{"siteMetadata":{"title":"Trainto.log()"}},"markdownRemark":{"id":"f2ff11eb-27ad-5fda-800b-276c952d9dbc","excerpt":"The last post, Replace EventBus with LiveData was introduced. This time, Implementing Zip function(Like Rx) using LiveData will be introduced. To acheive this…","html":"<p>The last post, <a href=\"https://trainto.me/android-replace-eventbus-with-livedata\">Replace EventBus with LiveData</a> was introduced.</p>\n<p>This time, Implementing Zip function(Like Rx) using LiveData will be introduced. To acheive this, MediatorLiveData, which extends LiveData, will be applied.</p>\n<p>MediatorLiveData is a LiveData subclass, can observe other LiveData objects and react on LiveData objects’ changes. Basic usage can be found <a href=\"https://developer.android.com/reference/android/arch/lifecycle/MediatorLiveData.html\">here</a>.</p>\n<p>If you’re reading this post, I’m sure that you already know well the concept of Zip function of Rx. Just in case, refer this <a href=\"http://reactivex.io/documentation/operators/zip.html\">page</a> for\nbasic concept of Zip function.</p>\n<p>As always, start with dependencies configuration.</p>\n<div class=\"gatsby-highlight\" data-language=\"groovy\"><pre class=\"language-groovy\"><code class=\"language-groovy\"><span class=\"token comment\">// This includes LiveDdata and ViewModel</span>\n<span class=\"token comment\">// If you want to add just LiveData, then use</span>\n<span class=\"token comment\">// \"android.arch.lifecycle:livedata:x.x.x\"</span>\nimplementation <span class=\"token string gstring\">\"android.arch.lifecycle:extensions:1.1.1\"</span></code></pre></div>\n<br>\nLet's assume that there is MainViewModel which calls two async retrofit calls.\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> MainViewModel <span class=\"token operator\">:</span> <span class=\"token function\">ViewModel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> name<span class=\"token operator\">:</span> MutableLiveData<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token function\">MutableLiveData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> age<span class=\"token operator\">:</span> MutableLiveData<span class=\"token operator\">&lt;</span>Int<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token function\">MutableLiveData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">getZippedLiveData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> LiveData <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">zip2</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> age<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> name<span class=\"token operator\">:</span> String<span class=\"token punctuation\">,</span> age<span class=\"token operator\">:</span> Int <span class=\"token operator\">-></span> <span class=\"token string\">\"name: <span class=\"token interpolation variable\">$name</span>, age: <span class=\"token interpolation variable\">$age</span>\"</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Async calls</span>\n        <span class=\"token comment\">// Asume there is RemoteApi class which implement Retrofit async call</span>\n        RemoteApi<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            it<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">let</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> it <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n\n        RemoteApi<span class=\"token punctuation\">.</span><span class=\"token function\">getAge</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            it<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">let</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>age<span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> it <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This ViewModel calls 2 async remote calls from start(), and result(name, age) will be saved to each MutableLiveData. And View(activity) will observe zipped LiveData, and zipped LiveData will be passed to the View by calling getZippedLiveData().</p>\n<p>The View(activity) code will look like below.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> MainActivity <span class=\"token operator\">:</span> <span class=\"token function\">AppCompatActivity</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> vm <span class=\"token operator\">=</span> ViewModelProviders<span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>MainViewModel<span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span>java<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">onCreate</span><span class=\"token punctuation\">(</span>savedInstanceState<span class=\"token operator\">:</span> Bundle<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">onCreate</span><span class=\"token punctuation\">(</span>savedInstanceState<span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\">// If both name and age are received from the remote calls,</span>\n        <span class=\"token comment\">// then show them in the TextView</span>\n        vm<span class=\"token punctuation\">.</span><span class=\"token function\">getZippedLiveData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">observe</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> Observer <span class=\"token punctuation\">{</span>\n            it<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">let</span> <span class=\"token punctuation\">{</span>\n                textView<span class=\"token punctuation\">.</span>text <span class=\"token operator\">=</span> it\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n        vm<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>So far this is typical android MVVM architecture using LiveData and ViewModel. The main point is how the zipped LiveData object can be created at getZippedLiveData() function of MainViewModel.</p>\n<p>Now let’s figure out how zipped LiveData can be created.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">fun</span> <span class=\"token operator\">&lt;</span>T1<span class=\"token punctuation\">,</span> T2<span class=\"token punctuation\">,</span> R<span class=\"token operator\">></span> <span class=\"token function\">zip2</span><span class=\"token punctuation\">(</span>src1<span class=\"token operator\">:</span> LiveData<span class=\"token operator\">&lt;</span>T1<span class=\"token operator\">></span><span class=\"token punctuation\">,</span> src2<span class=\"token operator\">:</span> LiveData<span class=\"token operator\">&lt;</span>T2<span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n                     zipper<span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>T1<span class=\"token punctuation\">,</span> T2<span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> R<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> LiveData<span class=\"token operator\">&lt;</span>R<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">return</span> MediatorLiveData<span class=\"token operator\">&lt;</span>R<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">var</span> src1Version <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n        <span class=\"token keyword\">var</span> src2Version <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n\n        <span class=\"token keyword\">var</span> lastSrc1<span class=\"token operator\">:</span> T1<span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n        <span class=\"token keyword\">var</span> lastSrc2<span class=\"token operator\">:</span> T2<span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n\n        <span class=\"token keyword\">fun</span> <span class=\"token function\">updateValueIfNeeded</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>src1Version <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> src2Version <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span>\n                lastSrc1 <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> lastSrc2 <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                value <span class=\"token operator\">=</span> <span class=\"token function\">zipper</span><span class=\"token punctuation\">(</span>lastSrc1<span class=\"token operator\">!!</span><span class=\"token punctuation\">,</span> lastSrc2<span class=\"token operator\">!!</span><span class=\"token punctuation\">)</span>\n                src1Version <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n                src2Version <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token function\">addSource</span><span class=\"token punctuation\">(</span>src1<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            lastSrc1 <span class=\"token operator\">=</span> it\n            src1Version<span class=\"token operator\">++</span>\n            <span class=\"token function\">updateValueIfNeeded</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token function\">addSource</span><span class=\"token punctuation\">(</span>src2<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            lastSrc2 <span class=\"token operator\">=</span> it\n            src2Version<span class=\"token operator\">++</span>\n            <span class=\"token function\">updateValueIfNeeded</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Above zip2 function takes two LiveData, src1 and src2. These are used as input source for MediatorLiveData to create. And also it takes zipper function(Imagine if this was Java… would be much more complicated!) as its last parameter, and it should describe how the data would be zipped into one object R(See getZippedLiveData() function of MainViewModel). In the updateValueIfNeeded() function, it checks version and null, and then set MediatorLiveData’s value.</p>\n<p>Simply The MediatorLiveData created issues(changing value) events only if all input source(src1, src2) are ready.</p>\n<p>This example is very simple case, but if you edit zip2 function you like, it can be applied various case. For example src1, src2 parameters can be replaced with vararg.</p>\n<p>Maybe you noticed this implementation does not behave exactly same with Rx’s zip. In this implementation, MediatorLiveData only takes the latest pair of input source. To make exactly same with Rx’s zip, input source’s history should be managed in the MediatorLiveData.</p>","frontmatter":{"title":"Android - Implementing Zip function using LiveData","date":"April 02, 2018","description":"Let's implement zip function like Rx using LiveData"}}},"pageContext":{"slug":"/android-implementing-zip-function-using-livedata/","previous":{"fields":{"slug":"/android-replace-eventbus-with-livedata/"},"frontmatter":{"title":"Android - Replace EventBus with LiveData"}},"next":{"fields":{"slug":"/javascript-map-set/"},"frontmatter":{"title":"Javascript(ES6) - Map and Set"}}}}}