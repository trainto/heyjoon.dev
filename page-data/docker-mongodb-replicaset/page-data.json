{"componentChunkName":"component---src-templates-blog-post-js","path":"/docker-mongodb-replicaset/","result":{"data":{"site":{"siteMetadata":{"title":"Trainto.log()"}},"markdownRemark":{"id":"93596f38-7efc-50f3-9405-686a9cc5307f","excerpt":"Setting up a MongoDB replica set on the one host might not make sense, but it can be useful to build up the dev environment. Because you don’t have to set up…","html":"<p>Setting up a MongoDB replica set on the one host might not make sense, but it can be useful to build up the dev environment. Because you don’t have to set up 2 or 3 servers to build dev environment. Instead having physical servers for MongoDB replica set, Docker can simulate it.</p>\n<h2>Install Docker</h2>\n<p>First of all, we should install Docker. To install Docker on your system, please refer <a href=\"https://docs.docker.com/install/linux/docker-ce/ubuntu/\">official document</a> for installing it.</p>\n<p>Ater installing Docker, we need docker-compose as well, so that we can set up MongoDB via docker-compose.yml.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">// Ubuntu\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> docker-compose</code></pre></div>\n<h2>docker-compose.yml</h2>\n<p>The following is yaml file for composing MongoDB replica set. This yaml file will compose primay, secondary and arbiter. I’m sure you already know well about replica set, but if you need more information about this, then refer MongoDB’s <a href=\"https://docs.mongodb.com/manual/core/replica-set-members/\">official document</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'3.3'</span>\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">mongo-primary</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> mongo<span class=\"token punctuation\">-</span>primary\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> mongo<span class=\"token punctuation\">:</span>4.0.11\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> $HOME/.dockerMongoRepl/primary/data/db<span class=\"token punctuation\">:</span>/data/db\n      <span class=\"token punctuation\">-</span> $HOME/.dockerMongoRepl/keyfile<span class=\"token punctuation\">:</span>/data/keyfile\n    <span class=\"token key atrule\">extra_hosts</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">'your.domain.example:192.168.1.xx'</span>\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> 27017<span class=\"token punctuation\">:</span><span class=\"token number\">27017</span>\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> always\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">MONGO_INITDB_ROOT_USERNAME</span><span class=\"token punctuation\">:</span> root\n      <span class=\"token key atrule\">MONGO_INITDB_ROOT_PASSWORD</span><span class=\"token punctuation\">:</span> yourpassword\n    <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>bind_ip_all <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>auth <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>keyFile /data/keyfile/mongo<span class=\"token punctuation\">-</span>cluster<span class=\"token punctuation\">-</span>key <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>replSet rs0 <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>enableMajorityReadConcern false\n  <span class=\"token key atrule\">mongo-secondary</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> mongo<span class=\"token punctuation\">-</span>secondary\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> mongo<span class=\"token punctuation\">:</span>4.0.11\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> $HOME/.dockerMongoRepl/secondary/data/db<span class=\"token punctuation\">:</span>/data/db\n      <span class=\"token punctuation\">-</span> $HOME/.dockerMongoRepl/keyfile<span class=\"token punctuation\">:</span>/data/keyfile\n    <span class=\"token key atrule\">depends_on</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> mongo<span class=\"token punctuation\">-</span>primary\n    <span class=\"token key atrule\">extra_hosts</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">'your.domain.example:192.168.1.xx'</span>\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> 27018<span class=\"token punctuation\">:</span><span class=\"token number\">27017</span>\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> always\n    <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>bind_ip_all <span class=\"token punctuation\">-</span>auth <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>keyFile /data/keyfile/mongo<span class=\"token punctuation\">-</span>cluster<span class=\"token punctuation\">-</span>key <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>replSet rs0 <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>enableMajorityReadConcern false\n  <span class=\"token key atrule\">mongo-arbiter</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> mongo<span class=\"token punctuation\">-</span>arbiter\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> mongo<span class=\"token punctuation\">:</span>4.0.11\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> $HOME/.dockerMongoRepl/arbiter/data/arb<span class=\"token punctuation\">:</span>/data/arb\n      <span class=\"token punctuation\">-</span> $HOME/.dockerMongoRepl/keyfile<span class=\"token punctuation\">:</span>/data/keyfile\n    <span class=\"token key atrule\">depends_on</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> mongo<span class=\"token punctuation\">-</span>primary\n    <span class=\"token key atrule\">extra_hosts</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">'your.domain.example:192.168.1.xx'</span>\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> 27019<span class=\"token punctuation\">:</span><span class=\"token number\">27017</span>\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> always\n    <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>bind_ip_all <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>auth <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>keyFile /data/keyfile/mongo<span class=\"token punctuation\">-</span>cluster<span class=\"token punctuation\">-</span>key <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>replSet rs0 <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>enableMajorityReadConcern false</code></pre></div>\n<p>If you google for Docker and MongoDB replica set, you can find a lot of docker-compose.yml examples similar above. They also work well, however none of them work properly when I try to connect it from remote client like Node.js.</p>\n<p>To make the replica set on Docker works properly with remote connection, we need to set “extra<em>hosts” and “ports”. In my case, I use asus router and its ddns, so “extra</em>hosts” value would be</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">extra_hosts</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token string\">'id.asuscomm.com:192.168.1.100'</span></code></pre></div>\n<p>The IP address is assigned by asus router, and domain is assigned by asus ddns service.</p>\n<p>And ports should be different for each node, in my case 27017, 27018 and 27019, so that we can specify different address for each node in the replica set.</p>\n<h2>Starting MongoDB replica set</h2>\n<p>In my case, I made sh script file to start it.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"> <span class=\"token comment\">#!/bin/sh</span>\n\n<span class=\"token function\">sudo</span> <span class=\"token function\">su</span> <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF\n\nmkdir <span class=\"token environment constant\">$HOME</span>/.dockerMongoRepl\nmkdir <span class=\"token environment constant\">$HOME</span>/.dockerMongoRepl/keyfile\n\nopenssl rand -base64 756 > <span class=\"token environment constant\">$HOME</span>/.dockerMongoRepl/keyfile/mongo-cluster-key\nchmod 400 <span class=\"token environment constant\">$HOME</span>/.dockerMongoRepl/keyfile/mongo-cluster-key\nchown 999:999 <span class=\"token environment constant\">$HOME</span>/.dockerMongoRepl/keyfile/mongo-cluster-key\nEOF</span>\n\n<span class=\"token function\">sudo</span> docker-compose up -d</code></pre></div>\n<p>This shell script file makes directories for MongoDB’s data and keyfile for security between replica nodes, and then stars MongoDB replica set using docker-compose.yml file introduced above.</p>\n<h2>Setting replica set</h2>\n<p>Now that MongoDB nodes are running on Docker, we need to config that the nodes can recognize each other.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">// Access to primary mongo image's  shell\n<span class=\"token function\">sudo</span> docker <span class=\"token builtin class-name\">exec</span> -it mongo-primary <span class=\"token function\">bash</span>\n// Execute mongo shell\nmongo -u root</code></pre></div>\n<p>When you try to execute mongo with -u options, it requires you to enter password. The password is the on you entered in docker-compose.yml.</p>\n<p>Once you entered mongo shell, to set up replica set, the following should be applied.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">config <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"_id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"rs0\"</span>,\n  <span class=\"token string\">\"members\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"_id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,\n    <span class=\"token string\">\"host\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"address.whichCanAccess.yourServer:27017\"</span>\n  <span class=\"token punctuation\">}</span>, <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"_id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,\n    <span class=\"token string\">\"host\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"address.whichCanAccess.yourServer:27018\"</span>\n  <span class=\"token punctuation\">}</span>, <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"_id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>,\n    <span class=\"token string\">\"host\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"address.whichCanAccess.yourServer:27019\"</span>,\n    arbiterOnly: <span class=\"token boolean\">true</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span>\n\nrs.initiate<span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Each “host” value would be the value you entered in docker-compose.yml as extra_hosts and ports. After above applied, if you see mongo’s shell prompt becoming like “rs0:PRIMARY>”, then everything is done.</p>","frontmatter":{"title":"Docker - Setting up a MongoDB Replica Set with Docker","date":"September 17, 2019","description":null}}},"pageContext":{"slug":"/docker-mongodb-replicaset/","previous":{"fields":{"slug":"/javascript-convert-string-number/"},"frontmatter":{"title":"Javascript - Convert String into Number"}},"next":{"fields":{"slug":"/nginx-nodejs/"},"frontmatter":{"title":"Nginx - Configure Nginx as reverse proxy for Nodejs(Express)"}}}}}